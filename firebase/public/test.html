<!DOCTYPE html>
<!--suppress EqualityComparisonWithCoercionJS -->
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <title>Annotation Interface - Duration</title>
</head>
<body>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script type="module">

        var firebaseConfig = {
            apiKey: "AIzaSyCEKSSQzuifi0bLqT7u2Lqz3_xGJinv6BI",
            authDomain: "duration-interface-firebase.firebaseapp.com",
            projectId: "duration-interface-firebase",
            storageBucket: "duration-interface-firebase.appspot.com",
            messagingSenderId: "794421775961",
            appId: "1:794421775961:web:ac47962b5bab9ce7e1ab48"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        var current_user = firebase.auth().currentUser;
        firebase.auth().onAuthStateChanged(function (current_user) {
            if (current_user) {
                if (current_user.displayName) {
                    document.getElementById('user_details').innerHTML = `
                        <p>Logged in with ${current_user.displayName}</p>
                    `;
                } else {
                    document.getElementById('user_details').innerHTML = `
                        <p>Logged in with ${current_user.email}</p>
                    `;
                }
            } else {
                window.location = 'index.html'
            }
        })

    </script>

    <script type="text/javascript">

        function Logout() {
            firebase.auth().signOut().then(function () {
                // Sign-out successfully.
                window.location = "index.html"
            }).catch(function (error) {
                // An error happened.
            })
        }


        function showReason() {
            document.getElementById('reason').style.display = 'block';
        }

        function hideReason() {
            document.getElementById('reason').style.display = 'none';
            document.getElementById('reason').value = "";
        }

        function uncheckQ1() {
            document.getElementById('q1_yes').checked = false;
            document.getElementById('q1_no').checked = false;
            document.getElementById('q1_hard').checked = false;
        }

        function clearError() {
            document.getElementById('error').textContent = "";
        }

        function validateForm() {

            var hours = document.getElementById('hours');
            var days = document.getElementById('days');
            var long = document.getElementById('long');
            var hard = document.getElementById('hard')
            var reason = document.getElementById('reason');
            var error = document.getElementById('error');

            if (hours.checked == false && days.checked == false && long.checked == false && hard.checked == false) {
                error.textContent = "Please tell me how long will the author of the tweet stay at the given city";
            } else if (hard.checked == true && reason.value.length < 15) {
                error.textContent = "The reason you provide is too short";
            } else {
                error.textContent = "";
                return true;
            }
            return false;

        }

        function addData() {

            // Get user's annotations
            var current_user = firebase.auth().currentUser;
            var worker_id = current_user.uid;
            var timestamp = new Date().toString();
            var instance_id = document.getElementById('instance_id').textContent;
            var q1_answer = document.querySelector('input[name="q1"]:checked').value;
            var q1_reason = document.getElementById('reason').value;

            // Save the annotation to the firebase database
            var annot = {
                instance_id: instance_id,
                worker_id: worker_id,
                timestamp: timestamp,
                q1_answer: q1_answer,
                q1_reason: q1_reason
            }
            firebase.firestore().collection('annotation1').add(annot).then(doc => {
                console.log(`Doc ${doc.id} added successfully.`)
            }).catch(e => {
                console.log(e)
            })
        }

        function combine() {
            var validate = validateForm();
            if (validate) {
                addData();
                clearError(); 
                hideDuration(); 
                hideReason(); 
                uncheckQ1();
                handleClick();
            } else {
                return false;
            }
        }

    </script>

    <div class="container">

        <div class="container">
            <button class="btn btn-outline-secondary pull-right" style="margin-top:10px; margin-bottom:10px;" data-toggle="button" aria-pressed="false" onclick="Logout()">Logout</button>
        </div>

        <div class="container">
            <p class="text-right" id="user_details" style="font-weight: 600;"></p>
        </div>
        <p style="text-align: center; margin: 30px; font-size: 30px; font-weight: bold">Determine how long people have stayed at the given city</p>
        <div class="row">

            <div class="col-sm-5">

                <!-- Instruction part -->
                <p style="font-size: 25px; font-weight: bold; color: rgb(194, 119, 7);">Instructions:</p>
                <p>
                    In this task, you will see a tweet.
                    <b>Your job is to determine how long the author of the tweet has stayed at the given city if it is not his/her home city</b>.
                    You will follow these steps:
                </p>
                <p>
                    <ol>
                        <li>First, you will read a tweet.</li>
                        <li>Second, you will determine how long the author of the tweet will continuously stay at the given city.</li>
                        <li>If you cannot answer the question above, please provide your reason.</li>
                    </ol>
                </p>

                <!-- Definition and Example part -->
                <p style="font-size: 25px; font-weight: bold; color: rgb(194, 119, 7);">Definitions and Examples:</p>

                <!-- Q1 part -->
                <div class="panel panel-default" style="margin-bottom: 5px;">

                    <!-- Definitions -->
                    <div class="panel-heading">

                        <!-- Definition of hours -->
                        <p>
                            <span style="font-size:18px; font-weight: bolder">Does the author of the tweet live in the given city?</span>
                        </p>
                        <p>
                            <span style="font-size: 15px; font-weight: bold; color: crimson;">0-24 hours:</span>
                            <span style="font-size: 15px">The author of the tweet will continuously stay at the given city for <u>0-24 hours</u> after publishing the tweet.</span>
                        </p>
                        <!-- Definition of days -->
                        <p>
                            <span style="font-size: 15px; font-weight: bold; color: crimson;">1-30 days:</span>
                            <span style="font-size: 15px">The author of the tweet will continuously stay at the given city for <u>1-30 days</u> after publishing the tweet.</span>
                        </p>
                        <!-- Definition of more than days -->
                        <p>
                            <span style="font-size: 15px; font-weight: bold; color: crimson;">More than 30 days:</span>
                            <span style="font-size: 15px">The author of the tweet will continuously stay at the given city for <u>more than 30 days</u> after publishing the tweet.</span>
                        </p>
                        <!-- Definition of I cannot determine -->
                        <p>
                            <span style="font-size: 15px; font-weight: bold; color: crimson;">I cannot determine:</span>
                            <span style="font-size: 15px"><u>I cannot determine</u> how long the author of the tweet will continuously stay at the given city.</span>
                        </p>

                    </div>

                    <!-- Examples -->
                    <div id="collapse1" class="panel-collapse collapse">
                        <div class="panel-body">
                            <!-- Example of Yes -->
                            <p style="font-size:12px">
                                <p style="margin: 10px; text-align: center; font-weight: bold">Example of <i>0-24 hours</i></p>
                                <img style="max-width: 300px; display: block; margin-left: auto; margin-right: auto;" src="https://zhaomin.s3.us-east-2.amazonaws.com/display/display_1244666583894589440.png" />
                                <p style="margin: 10px">
                                    The text and image show the flower in the bathroom of the apartment/house.
                                    Therefore, we can tell that author of the tweet lives in <span style="color: #4A8FFF"><b>Charlottle</b></span>.
                                </p>
                            </p>
                            <!-- Example of No -->
                            <p style="font-size:12px">
                                <p style="margin: 10px; text-align: center; font-weight: bold">Example of <i>1-30 days</i></p>
                                <img style="max-width: 300px; display: block; margin-left: auto; margin-right: auto;" src="https://zhaomin.s3.us-east-2.amazonaws.com/display/display_1385388145974267905.png" />
                                <p style="margin: 10px">
                                    The text shows that the author of the tweet is in <span style="color: #4A8FFF"><b>Kennebunkport</b></span> for vacation,
                                    which means that he does not live there.
                                </p>
                            </p>
                            <!-- Example of No -->
                            <p style="font-size:12px">
                                <p style="margin: 10px; text-align: center; font-weight: bold">Example of <i>More than 30 days</i></p>
                                <img style="max-width: 300px; display: block; margin-left: auto; margin-right: auto;" src="https://zhaomin.s3.us-east-2.amazonaws.com/display/display_1385388145974267905.png" />
                                <p style="margin: 10px">
                                    The text shows that the author of the tweet is in <span style="color: #4A8FFF"><b>Kennebunkport</b></span> for vacation,
                                    which means that he does not live there.
                                </p>
                            </p>
                            <!-- Example of I cannot determine -->
                            <p style="font-size:12px">
                                <p style="margin: 10px; text-align: center; font-weight: bold">Example of <i>I cannot determine</i></p>
                                <img style="max-width: 300px; display: block; margin-left: auto; margin-right: auto;" src="https://zhaomin.s3.us-east-2.amazonaws.com/display/display_1240744731421880331.png" />
                                <p style="margin: 10px">
                                    We cannot determine if the author of the tweet lives in the <span style="color: #4A8FFF"><b>Phoenix</b></span> because we need more information.
                                </p>
                            </p>
                        </div>
                    </div>

                </div>
                <p style="margin-left: 10px; font-weight: bolder; font-size: 13px;">(click <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">HERE</a> to see/hide examples of the above question)</p>

            </div>

            <!-- display the tweet and questions -->
            <div class="col-sm-7">
                <p style="font-size: 20px; font-weight: bold; color: rgb(194, 119, 7);">Read the tweet and answer the questions about the author of the tweet:<span id="instance_id" style="display: none"></span></p>
                <div class="panel panel-default">
                    <div class="panel-body">

                        <!-- Show tweet -->
                        <div class="row">
                            <div class="col-sm-12">
                                <img id="image_link" style="max-width: 350px; display: block; margin-left: auto; margin-right: auto; margin-bottom: 20px" src="" />
                            </div>
                        </div>

                        <!-- Show questions -->
                        <div class="row">

                            <!-- Show Q1 -->
                            <div id="q1_question" class="col-sm-12 col-sm-offset-1">
                                <p>How long will the author of the tweet continuously stay at <span id="location_q1" style="color: #4A8FFF; font-weight: bold;"></span> after publishing this tweet?</p>
                                <div class="form-check-inline" style="margin-bottom: 10px">

                                    <label class="form-check-label">
                                        <input type="radio" class="form-check-input" id="hours" name="q1" value="less_than_24_hours" style="margin-right: 10px" onclick="hideDuration(); hideReason(); clearError()" />0-24 hours
                                    </label>
                                    <br />
                                    <label class="form-check-label">
                                        <input type="radio" class="form-check-input" id="days" name="q1" value="less_than_one_month" style="margin-right: 10px" onclick="showDuration(); hideReason(); clearError()" />1-30 days
                                    </label>
                                    <br />
                                    <label class="form-check-label">
                                        <input type="radio" class="form-check-input" id="long" name="q1" value="more_than_one_month" style="margin-right: 10px" onclick="showDuration(); hideReason(); clearError()" />More than 30 days
                                    </label>
                                    <br />
                                    <label class="form-check-label">
                                        <input type="radio" class="form-check-input" id="hard" name="q1" value="hard" style="margin-right: 10px" onclick="hideDuration(); showReason(); clearError(); clearError()" />I cannot determine
                                    </label>
                                    <br />

                                </div>
                                <div class="form-group">
                                    <textarea class="form-control" id="reason" rows="3" minlength="15" style="max-width: 70%; display: none;" placeholder="Please tell us why you cannot determine (at least 15 characters)"></textarea>
                                </div>
                            </div>

                        </div>

                        <!-- Submit button and error message (if any) -->
                        <div class="row text-center" style="margin-bottom: 15px;">
                            <span id="error" style="margin: 20px; color: red; font-weight: bold"></span>
                        </div>

                        <div class="row text-center">
                            <button id="submitButton" class="btn btn-primary" onclick="combine()">Next</button>
                        </div>


                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>

        var latestDoc = null;

        const loadNext = async () => {

            // Load next instance
            const ref = firebase
                .firestore()
                .collection('data1')
                .orderBy('instance_id')
                .startAfter(latestDoc || 0)
                .limit(1);

            const data = await ref.get();

            data.docs.forEach(doc => {
                const instance = doc.data();
                document.getElementById('instance_id').textContent = instance.instance_id;
                document.getElementById('image_link').src = instance.image_link;
                document.getElementById('location_q1').textContent = instance.location;
                document.getElementById('location_duration').textContent = instance.location;
            })

            // Update latest doc
            latestDoc = data.docs[data.docs.length - 1];

            // Unattach event listeners if there is no more data
            if (data.empty) {
                loadMore.removeEventListener('click', handleClick);
                document.getElementById('submitButton').style.display = 'none';
                document.getElementById('error').textContent = 'You have completed all tasks! Thank you!'
            }
        }

        // Wait for DOM content to load
        window.addEventListener('DOMContentLoaded', () => loadNext());

        // Load more data
        const loadMore = document.getElementById('submitButton');
        const handleClick = () => {
            loadNext();
        }
        // loadMore.addEventListener('click', handleClick);
    </script>
</body>
</html>
